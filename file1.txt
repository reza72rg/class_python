#!/bin/bash

USER="ansible"
SSH_KEY="/home/ansible/.ssh/id_rsa.pub"
IP_FILE="servers.txt"

function check_port() {
    local ip=$1
    local port=$2
    timeout 2 bash -c "</dev/tcp/$ip/$port" &>/dev/null
    return $?
}

while IFS= read -r ip || [[ -n "$ip" ]]; do
    echo "ğŸ” Checking $ip..."

    if check_port "$ip" 22500; then
        PORT=22500
        echo "[$ip] âœ… Port 22500 is open."
    elif check_port "$ip" 22; then
        PORT=22
        echo "[$ip] âš ï¸ Port 22500 closed, trying port 22... Port 22 is open."
    else
        echo "[$ip] âŒ Error: Neither port 22500 nor port 22 is open."
        echo "-----------------------------------"
        continue
    fi

    echo "[$ip] Trying ssh-copy-id with port $PORT..."

    # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ Ú©Ù„ÛŒØ¯ Ø¨Ø§ ssh-copy-id (ØªØ¹Ø§Ù…Ù„ÛŒØŒ Ù¾Ø³ÙˆØ±Ø¯ Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ù¾Ø±Ø³ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø§Ú¯Ø± Ù„Ø§Ø²Ù… Ø¨Ø§Ø´Ø¯)
    ssh-copy-id -i "$SSH_KEY" -p "$PORT" "$USER@$ip"

    if [ $? -ne 0 ]; then
        echo "[$ip] âŒ Error: ssh-copy-id failed â€” wrong password or access denied."
        echo "-----------------------------------"
        continue
    fi

    echo "[$ip] âœ… ssh-copy-id succeeded."
    echo "-----------------------------------"

done < "$IP_FILE"

