#!/bin/bash

USER="ansible"
SSH_KEY="/home/ansible/.ssh/id_rsa.pub"
IP_FILE="servers.txt"
PASSWORD="your_password_here"   # <== ÿß€åŸÜÿ¨ÿß Ÿæÿ≥Ÿàÿ±ÿØ ssh ÿ±Ÿà Ÿàÿßÿ±ÿØ ⁄©ŸÜ

function check_port() {
    local ip=$1
    local port=$2
    timeout 2 bash -c "</dev/tcp/$ip/$port" &>/dev/null
    return $?
}

while IFS= read -r ip || [[ -n "$ip" ]]; do
    echo "üîç Checking $ip..."

    if check_port "$ip" 22500; then
        PORT=22500
        echo "[$ip] ‚úÖ Port 22500 is open."
    elif check_port "$ip" 22; then
        PORT=22
        echo "[$ip] ‚ö†Ô∏è Port 22500 closed, trying port 22... Port 22 is open."
    else
        echo "[$ip] ‚ùå Error: Neither port 22500 nor port 22 is open."
        echo "-----------------------------------"
        continue
    fi

    echo "[$ip] Trying ssh-copy-id with port $PORT..."

    sshpass -p "$PASSWORD" ssh-copy-id -i "$SSH_KEY" -p "$PORT" "$USER@$ip"

    if [ $? -ne 0 ]; then
        echo "[$ip] ‚ùå Error: ssh-copy-id failed ‚Äî wrong password or access denied."
        echo "-----------------------------------"
        continue
    fi

    echo "[$ip] ‚úÖ ssh-copy-id succeeded."
    echo "-----------------------------------"

done < "$IP_FILE"

